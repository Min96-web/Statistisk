---
title: "Statistik och dataanalys II, 15 hp "
subtitle: "Inl√§mningsuppgift 1, 2.5 hp"
author: 
- Johanna Sel√∂
- Minhui Zhong
- Emil Fagerlund
- William Olsson Lundgren
date: last-modified
format: 
  html:
    self-contained: true
    code-line-numbers: true
  pdf: default  
  docx: default
toc: true
language: 
  title-block-author-single: " "
toc-title-document: "Inneh√•ll"
crossref-fig-title: "Figur"
theme: Superhero
title-block-banner-color: Primary
title-block-published: "Publicerad"
author-title: "Gruppmedlemmar"
title-block-banner: true
callout-warning-caption: "Varning"
callout-note-caption: "Observera"
callout-tip-caption: "Tips"
editor: visual
---

# Introduktion

```{r}
#| echo: false 
#| output: false
library(tidyverse)
library(remotes)
library(sda123)
library(SUdatasets)
```

F√∂r varje (del)uppgift ska ni inkludera en kort sammanfattning av uppgiften samt ert svar. Svaret ska inneh√•lla en beskrivning av vad ni har gjort, samt era slutsatser och tolkningar.

# Del 1 - Linj√§r regression med interaktionseffekter

```{r}
#| echo: false 
#| output: false
#remotes::install_github("avehtari/ROS-Examples", subdir = "rpackage")
library(rosdata)
```

```{r}
earnings <- tibble(earnings)
earnings
```

Er uppgift √§r att skatta en linj√§r regressionsmodell med √•rlig inkomst i USD (**earn**) som responsvariabel. Med hj√§lp av denna modell ska ni unders√∂ka om sambandet mellan inkomst och utbildningsniv√• (antal √•r, **education**) skiljer sig beroende p√• k√∂n (**male**) eller inte.

## 1a - Deskriptiv analys

-   Skapa ett nytt dataset baserat p√• **earnings** som endast inneh√•ller variablerna i listan ovan.

-   Exkludera alla observationer f√∂r vilka **earn** = 0.

-   Exkludera alla observationer som inte √§r kompletta. Anv√§nd funktionen **drop_na()** f√∂r att skapa ett dataset som endast inneh√•ller kompletta observationer.

```{r}
earnings_new <- earnings %>% select(earn, height, weight, male, ethnicity, education, age) %>% filter(earn > 0) %>% mutate(logearn = log(earn))
earnings_new <- drop_na(earnings_new)
earnings_new
```

-   G√∂r en deskriptiv analys av dem olika variablerna i datasetet (exempelvis stapeldiagram f√∂r kategoriska variabler och histogram f√∂r numeriska). Finns det n√•gra outliers? B√∂r dessa tas bort?

```{r}
suppressMessages(library(mosaic))
ggplot(data = earnings_new, aes(x = logearn)) +
     geom_histogram(bins = 30)
ggplot(data = earnings_new, aes(x = height)) +
     geom_histogram()
ggplot(data = earnings_new, aes(x = weight )) +
     geom_histogram()
ggplot(data = earnings_new, aes(x = age )) +
     geom_histogram()
bargraph(~ male, data = earnings_new, type = "proportion")
bargraph(~ ethnicity, data = earnings_new, type = "proportion")
bargraph(~ education, data = earnings_new, type = "proportion")
```

```{r}
# plocka bort outliers
earnings_new <- earnings_new %>% filter(logearn < 12.5, logearn > 6)
# en deskriptiv analys av sambandet mellan earn(responsvariabeln) och √∂vriga variabler
earnings_new %>% group_by(male) %>% summarise(avg = mean(logearn),sd = sd(logearn))
```

```{r}
library(ggplot2)
ggplot(earnings_new, aes(x = age, y = earn)) +
  geom_point() +
  labs(title = "Spridningsdiagram", x = "age", y = "earn")
```

## 1b - Populationsmodellen

Svara p√• fr√•gan om sambandet mellan **earn** och **education** skiljer sig √•t mellan kvinnor och m√§n.

-   Skapa en ny centrerad version av education, **education_c** genom att subtrahera mean(education) fr√•n education.

```{r}
earnings_new <- earnings_new %>% mutate(education_c = education - mean(education))
earnings_new
```

```{r}
earnings_new <- earnings_new %>% mutate(age_c = age - mean(age))
earnings_new
```

-   Formulera en populationsmodell som l√•ter er besvara fr√•gan ovan. Motivera vilka prediktorer ni inkluderar urifr√•n 1a. Det √§r fritt fram att inkludera s√• m√•nga prediktorer som ni vill!

earn = B0 + B1education_c+ B2ethnicity + B3Male

```{r}
popmodel <- lm(earn ~ education_c + ethnicity + male, earnings_new)
reg_summary(lm(popmodel))
```

# Del 2 - Multipel regression

## 2a - F-test av restriktioner

I den h√§r √∂vningen ska ni formulera tv√• modeller, och sen j√§mf√∂ra dem med ett F-test. Den f√∂rsta modellen ska vara en enkel modell som √§r l√§tt att tolka. Den f√•r som mest ha en numerisk och en kategorisk prediktor. Den andra modellen f√•r vara hur komplex som helst, men m√•ste inneh√•lla alla prediktorer i den enklare modellen, plus minst tv√• prediktorer till.

-   F√∂rs√∂k identifiera den b√§sta enkla regressionsmodellen ni kan baserat p√• R2. Modellen ska inneh√•lla en numerisk prediktor och upp till en kategorisk prediktor. F√∂r att j√§mf√∂relsen ska vara giltig s√• m√•ste responsvariabeln vara p√• samma skala f√∂r varje modell. Ni kan allts√• anv√§nda orginalskala f√∂r alla, eller exempelvis logskala f√∂r alla, men inte j√§mf√∂ra modeller p√• orginal- och logskala.

```{r}
# Restricted 
#install.packages("corrr")
library(corrr)

earnings_new <- earnings_new %>% mutate(white = ifelse(ethnicity == "White", 1, 0), 
                        hispanic = ifelse(ethnicity == "Hispanic", 1, 0), 
                        other = ifelse(ethnicity == "Other", 1, 0), 
                        black = ifelse(ethnicity == "Black", 1, 0))

correlate(earnings_new)

enkel <- lm(logearn ~ education + ethnicity, earnings_new)
reg_summary(lm(enkel))
```

-   Plotta den enkla regressionsmodellen p√• samma s√§tt som ni gjorde i uppgift 2b i labb 1.

```{r}
#Unrestricted 
full_modell <- lm(logearn ~ education + ethnicity + male + height + age, earnings_new)
reg_summary(lm(full_modell))

```

```{r}
ggplot(earnings_new, aes(x = education, y = logearn, col = ethnicity)) +
  geom_point() + 
  geom_smooth(method = "lm")
```

-   F√∂rs√∂k identifiera den b√§sta regressionsmodellen ni kan baserat p√• R2. Modellen ska inneh√•lla samma som ovan plus minst tv√• predikktorer till.

```         
```

-   Anv√§nd ett F-test f√∂r att formellt j√§mf√∂ra dem tv√• modellerna. St√§ll upp testet ordentligt, dvs specificera noll- och alternativhypotes, teststatistika, f√∂rkastelseomr√•de samt slutsats. Anv√§nd a = 0.05.

H0 = B3 = B4 = B5 = 0

HA = Bj √§r skilt fr√•n 0 d√§r j 3, 4, 5

(R2 fulla modell - R2 restricted) / antal prediktor - restric prediktor / 1 - r2 fulla modellen /n-k-1

0.22 - 0.1218 = 0.0982 / 3 = 0.0327333 / 0.78 / 1599 = 67.1032 = Teststatistika

qf = 2.21

F√∂rkastar nollhyposten och fastsl√•r att den fulla modellen √§r mer l√§mplig att anv√§nda p√• 5% signifikansniv√•.

-   Skriv ner dom matematiska uttrycken f√∂r ÔøΩ2 och justerad ÔøΩ2. Hur stor √§r skillnaden i ÔøΩ2 mellan dom tv√• modellerna? Hur stor √§r skillnaden i justerad ÔøΩ2?

**FULL MODELL:**

R2 = SSR/SST = 271.63 / 1234.57 = 0.2200

R2adjusted = 1 - (SSE/n-p-1) / (SST/(n-1)) = 0.21169

**REDUCERAD MODELL:**

R2 = SSR/SST = 150.34 / 1234.57 = 0.1218

R2adjusted = 1 - (SSE/n-p-1) / (SST/(n-1)) = 0.11957

```{r}

qf(0.95, 5, 1599)

qf(1-0.05, df1 = 5, df2 = 1599)
```

## 2b - Whites test

H0 = feltermerna har samma varians (homoskedastiska)

HA = feltermerna har olika varians (heteroskedastiska)

```{r}

earnings_new <- earnings_new %>% mutate(e2 = enkel$residuals^2) %>% mutate(education2 = education^2)


reg_white <- lm(logearn ~ education + education2 + ethnicity + education:ethnicity, earnings_new) 
reg_summary(lm(reg_white))

```

Teststatiska: 0.12572 ¬∑ 1605 = 201.7806

```{r}
qchisq(0.95, 4)
```

Vi f√∂rkastar H0 p√• 5% signifikansniv√•.

## Del 4 - Konstruera en tentafr√•ga

Block 1: F2-F3 Linj√§r regression med interaktionseffekter - tidyverse och ggplot2

Block 2: Multipel linj√§r regression F4-F5 F-test, multikollinearitet, modellantaganden och VIF

Block3: Logistisk regression F6-F8 Logistisk regression, maximum likelihood, klassificering, kNN(maskininl√§rning)

En fr√•ga i en block ska ing√• tv√• fr√•gor som √§r b√•de enkel och sv√•r.

## **F-test f√∂r j√§mf√∂relse mellan modeller**

I den haÃàr uppgiften ska du anvaÃànda ett F-test foÃàr att undersoÃàka om det aÃàr en bra att inkludera etnicitet i foÃàljande modell: earn = ùõΩ0 + ùõΩ1education + ùõΩ2male + ùõΩ3ethnicity + ùõΩ4age + ùúÄ

```{r}
earnings_new$male <- as.factor(earnings_new$male)
full_model <- lm(logearn ~ education + male + ethnicity + age, earnings_new)
reg_summary(full_model) 
reducerad_model <- lm(logearn ~ education + male + age, earnings_new)
reg_summary(reducerad_model)
```

1\. BeraÃàkna vaÃàrdet paÃä teststatistikan.

F-test H0:beta 3 = beta 4=beta5=0

H1:Inga restriktioner p√• regressionskoefficienterna

F√∂r att utf√∂r ett F-test i de tv√• modellen kr√§ver vi ta reda p√• (( RFM\^2-RRM\^2)/(p-q))/((1-RFM\^2)/(n-p-1)

Vi vet att RFM\^2 = 0.21815, RRM\^2 = 0.21578, n=1600, p=6, q=3

Fobs = ((0.21815-0.21578)/(6-3))/((1-0.21815)/(1600-6-1)) ‚âà 0.00079/0.0004908035 ‚âà 1.609605

enligt qt funktion i r fick jag ca 2.09 som Fcrit

2.BeraÃàkna det kritiska vaÃàrdet med hjaÃàlp av qf() foÃàr ùõº = 0.1. Vad blir din slutsats?

```{r}
n <- nrow(earnings_new)
qf(1 - 0.1, df1 = 3 , df2 = 1600 - 6 - 1)
```

allts√• jag fick att Fobs \< Fcrit d√• kan ej f√∂rkasta jag H0.

3.  BeraÃàkna VIF med hjaÃàlp av foÃàrklaringsgraden.

Ber√§kna VIF f√∂r etnicitet: F√∂r att ber√§kna ut VIF kr√§vs vi R2-adj fr√•n modellen som ig√•r etnicitet. D√• jag fick 0.21815 i full_model.

```{r}
1/(1-0.21815)
#Tumregel: VIF > 10 √§r stark multikollinearitet.
```
